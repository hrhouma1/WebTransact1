# 9. OpÃ©rations CRUD pour l'entitÃ© Card

---

# Objectif - Le but de cet exercice est de maÃ®triser les opÃ©rations CRUD

---

Dans cette section, nous allons couvrir les quatre opÃ©rations CRUD (Create, Read, Update, Delete) pour l'entitÃ© `Card` en utilisant le contrÃ´leur `CardController`. Ces opÃ©rations sont fondamentales dans le dÃ©veloppement d'applications web transactionnelles, oÃ¹ l'interaction avec une base de donnÃ©es est essentielle pour gÃ©rer les informations des utilisateurs, tels que les cartes de crÃ©dit associÃ©es aux clients. Un web transactionnel typique, comme un site de commerce en ligne, repose sur ces opÃ©rations pour ajouter, lire, mettre Ã  jour et supprimer des donnÃ©es (transactions), garantissant ainsi la cohÃ©rence et l'intÃ©gritÃ© des transactions au sein du systÃ¨me. Avant de commencer, rappelons comment nous avons configurÃ© le `CardRepository`, qui joue un rÃ´le central dans ces opÃ©rations.

---

## Table des MatiÃ¨res

1. <a href="#transaction">Qu'est-ce qu'une transaction et pourquoi parle-t-on de web transactionnel ?</a>
2. <a href="#acid">PropriÃ©tÃ©s ACID</a>
3. <a href="#repository">Rappel du `CardRepository`</a>
4. <a href="#structure">Structure du projet</a>
5. <a href="#create">C - Create (CrÃ©er une nouvelle carte)</a>
6. <a href="#read">R - Read (Lire toutes les cartes ou une carte spÃ©cifique)</a>
7. <a href="#update">U - Update (Mettre Ã  jour une carte existante)</a>
8. <a href="#delete">D - Delete (Supprimer une carte)</a>
9. <a href="#resume">RÃ©sumÃ© des OpÃ©rations CRUD et du `CardRepository`</a>
10. <a href="#postman">Annexe 1 : Utilisation de Postman</a>
11. <a href="#methods">Annexe 2 : MÃ©thodes du `CardRepository`</a>

---

<a id="transaction"></a>
# Qu'est-ce qu'une transaction et pourquoi parle-t-on de web transactionnel ?

---

Une **transaction** en informatique est une unitÃ© complÃ¨te de traitement composÃ©e de plusieurs opÃ©rations qui doivent Ãªtre exÃ©cutÃ©es de maniÃ¨re atomique et cohÃ©rente. Autrement dit, toutes les Ã©tapes d'une transaction doivent Ãªtre accomplies avec succÃ¨s pour que la transaction soit validÃ©e (commit). Si une seule Ã©tape Ã©choue, l'ensemble des opÃ©rations est annulÃ© (rollback), garantissant ainsi l'intÃ©gritÃ© des donnÃ©es.

**Exemples de transactions :**
- **Transfert bancaire** : DÃ©biter un compte et crÃ©diter un autre. Si l'une des opÃ©rations Ã©choue, ni le dÃ©bit ni le crÃ©dit ne doivent Ãªtre appliquÃ©s.
- **Commande en ligne** : Enregistrer la commande, mettre Ã  jour le stock, et traiter le paiement. Toutes ces Ã©tapes doivent rÃ©ussir pour que la commande soit validÃ©e.

---

<a id="acid"></a>
# PropriÃ©tÃ©s ACID :

---

Les transactions doivent respecter les propriÃ©tÃ©s ACID :
- **AtomicitÃ©** : Toutes les opÃ©rations de la transaction sont rÃ©alisÃ©es ou aucune ne l'est.
- **CohÃ©rence** : La transaction amÃ¨ne la base de donnÃ©es d'un Ã©tat cohÃ©rent Ã  un autre Ã©tat cohÃ©rent.
- **Isolation** : Les effets des transactions en cours ne sont pas visibles par d'autres transactions.
- **DurabilitÃ©** : Une fois qu'une transaction est validÃ©e (commit), ses effets sont permanents, mÃªme en cas de panne.

Ainsi, une transaction n'est pas simplement une interaction avec une base de donnÃ©es, mais un ensemble d'opÃ©rations qui doivent Ãªtre traitÃ©es comme un tout, garantissant l'intÃ©gritÃ© et la fiabilitÃ© des donnÃ©es dans un systÃ¨me.

---

<a id="structure"></a>
```
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘ CRUD OPERATIONS â•‘
â•”â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•—
â•‘                                     â•‘
â•‘   â›ï¸  INSERTION (C)                  â•‘
â•‘                                     â•‘
â•‘   ğŸ” AFFICHAGE (R)                   â•‘
â•‘                                     â•‘
â•‘   ğŸ”§ UPDATE (U)                      â•‘
â•‘                                     â•‘
â•‘   ğŸ—‘ï¸  DELETE (D)                     â•‘
â•‘                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

<a id="structure"></a>
# Structure du projet 

---

```plaintext
cards-app
â”œâ”€â”€ src
â”‚   â””â”€â”€ main
â”‚       â””â”€â”€ java
â”‚           â””â”€â”€ com
â”‚               â””â”€â”€ exemple
â”‚                   â””â”€â”€ demo
â”‚                       â”œâ”€â”€ model
â”‚                       â”‚   â”œâ”€â”€ Customer.java
â”‚                       â”‚   â””â”€â”€ Card.java
â”‚                       â”œâ”€â”€ repository
â”‚                       â”‚   â””â”€â”€ CardRepository.java
â”‚                       â””â”€â”€ controller
â”‚                           â””â”€â”€ CardController.java
â””â”€â”€ application.properties
```

---

<a id="repository"></a>
# 9.0. Rappel du `CardRepository`

---

Le `CardRepository` est une interface essentielle qui permet de manipuler les donnÃ©es de l'entitÃ© `Card`. Voici comment il a Ã©tÃ© configurÃ© :

**Code du `CardRepository` :**

```java
package com.exemple.demo.repository;

import com.exemple.demo.model.Card;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CardRepository extends JpaRepository<Card, Integer> {
    // Laisser vide pour le moment
}
```

- **Explication** : Le `CardRepository` hÃ©rite de `JpaRepository`, qui offre un ensemble de mÃ©thodes CRUD dÃ©jÃ  prÃªtes Ã  l'emploi, telles que `save()`, `findAll()`, `findById()`, et `delete()`.

---

<a id="create"></a>
# 9.1. C - Create (CrÃ©er une nouvelle carte)

---

Pour crÃ©er une nouvelle carte, nous utilisons une requÃªte POST. Le contrÃ´leur `CardController` reÃ§oit un objet `Card` en JSON et l'enregistre dans la base de donnÃ©es en utilisant le `CardRepository`.

**Rappel :** Nous avons dÃ©jÃ  ajoutÃ© un client `Rehouma Haythem` Ã  la base de donnÃ©es avec l'ID `1`. Assurez-vous que ce client existe avant d'ajouter une carte pour lui.

**Code dans `CardController` :**

```java
@PostMapping("/add")
public Card addCard(@RequestBody Card card) {
    // Utilisation du repository pour sauvegarder la carte
    return cardRepository.save(card);
}
```

- **RÃ´le du `CardRepository`** : Ici, le `CardRepository` est utilisÃ© pour sauvegarder la carte dans la base de donnÃ©es en appelant la mÃ©thode `save()`, qui est une mÃ©thode prÃ©dÃ©finie dans `JpaRepository`.

**RequÃªte POST via Postman :**

```json
POST http://localhost:8080/cards/add

{
    "customerId": 1,
    "cardNumber": "1234-5678-9012-3456",
    "cardType": "Visa",
    "totalLimit": 5000,
    "amountUsed": 1000,
    "availableAmount": 4000,
    "createDt": "2024-08-30"
}
```

- **DÃ©tails dans Postman :**
  - **URL** : Entrez `http://localhost:8080/cards/add` dans la barre d'URL.
  - **MÃ©thode** : SÃ©lectionnez `POST`.
  - **Body** : Choisissez `raw` et `JSON` puis collez le JSON ci-dessus dans le champ.

---

<a id="read"></a>
# 9.2. R - Read (Lire toutes les cartes ou une carte spÃ©cifique)

---

Pour lire les cartes, nous utilisons une requÃªte GET. Vous pouvez rÃ©cupÃ©rer toutes les cartes ou une carte spÃ©cifique par son ID en utilisant les mÃ©thodes fournies par `CardRepository`.

**Lire toutes les cartes :**

```java
@GetMapping("/all")
public List<Card> getAllCards() {
    // Utilisation du repository pour rÃ©cupÃ©rer toutes les cartes
    return cardRepository.findAll();
}
```

- **RÃ´le du `CardRepository`** : La mÃ©thode `findAll()` est utilisÃ©e ici pour rÃ©cupÃ©rer toutes les cartes de la base de donnÃ©es. Cette mÃ©thode est Ã©galement fournie par `JpaRepository`.

**RequÃªte GET via le navigateur ou Postman :**

```http
GET http://localhost:8080/cards/all
```

**Lire une carte spÃ©cifique par son ID :**

```java
@GetMapping("/{id}")
public ResponseEntity<Card> getCardById(@PathVariable int id) {
    // Utilisation du repository pour rÃ©cupÃ©rer une carte par ID
    return cardRepository.findById(id)
            .map(card -> ResponseEntity.ok().body(card))
            .orElse(ResponseEntity.notFound().build());
}
```

- **RÃ´le du `CardRepository`** : La mÃ©thode `findById(int id)` permet de rÃ©cupÃ©rer une carte spÃ©cifique par son ID.

**RequÃªte GET pour une carte spÃ©cifique :**

```http
GET http://localhost:8080/cards/1
```

---

<a id="update"></a>
# 9.3. U - Update (Mettre Ã  jour une carte existante)

---

Pour mettre Ã  jour une carte, nous utilisons une requÃªte PUT. Vous pouvez modifier les dÃ©tails d'une carte en spÃ©cifiant son ID. Le `CardRepository` nous fournit la mÃ©thode `save()` qui sera utilisÃ©e pour sauvegarder les modifications.

**Code dans `CardController` :**

```java
@PutMapping("/{id}")
public ResponseEntity<Card> updateCard(@PathVariable int id, @Request

Body Card cardDetails) {
    // Utilisation du repository pour mettre Ã  jour la carte
    return cardRepository.findById(id)
            .map(card -> {
                card.setCardNumber(cardDetails.getCardNumber());
                card.setCardType(cardDetails.getCardType());
                card.setTotalLimit(cardDetails.getTotalLimit());
                card.setAmountUsed(cardDetails.getAmountUsed());
                card.setAvailableAmount(cardDetails.getAvailableAmount());
                card.setCreateDt(cardDetails.getCreateDt());
                Card updatedCard = cardRepository.save(card);
                return ResponseEntity.ok().body(updatedCard);
            }).orElse(ResponseEntity.notFound().build());
}
```

- **RÃ´le du `CardRepository`** : Ici, la mÃ©thode `save()` est de nouveau utilisÃ©e pour sauvegarder les modifications apportÃ©es Ã  la carte.

**RequÃªte PUT via Postman :**

```json
PUT http://localhost:8080/cards/1

{
    "cardNumber": "4321-8765-2109-6543",
    "cardType": "MasterCard",
    "totalLimit": 7000,
    "amountUsed": 2000,
    "availableAmount": 5000,
    "createDt": "2024-09-01"
}
```

- **DÃ©tails dans Postman :**
  - **URL** : Entrez `http://localhost:8080/cards/1` dans la barre d'URL.
  - **MÃ©thode** : SÃ©lectionnez `PUT`.
  - **Body** : Choisissez `raw` et `JSON` puis collez le JSON ci-dessus dans le champ.

---

<a id="delete"></a>
# 9.4. D - Delete (Supprimer une carte)

---

Pour supprimer une carte, nous utilisons une requÃªte DELETE. Le `CardRepository` nous fournit la mÃ©thode `delete()` pour effectuer cette opÃ©ration.

**Code dans `CardController` :**

```java
@DeleteMapping("/{id}")
public ResponseEntity<Void> deleteCard(@PathVariable int id) {
    // Utilisation du repository pour supprimer la carte
    return cardRepository.findById(id)
            .map(card -> {
                cardRepository.delete(card);
                return ResponseEntity.ok().build();
            }).orElse(ResponseEntity.notFound().build());
}
```

- **RÃ´le du `CardRepository`** : Ici, `delete()` est utilisÃ© pour supprimer une carte de la base de donnÃ©es.

**RequÃªte DELETE via Postman :**

```http
DELETE http://localhost:8080/cards/1
```

- **DÃ©tails dans Postman :**
  - **URL** : Entrez `http://localhost:8080/cards/1` dans la barre d'URL.
  - **MÃ©thode** : SÃ©lectionnez `DELETE`.

---

<a id="resume"></a>
# 9.5. RÃ©sumÃ© des OpÃ©rations CRUD et du `CardRepository`

---

Le `CardRepository` joue un rÃ´le crucial dans toutes les opÃ©rations CRUD pour l'entitÃ© `Card`. GrÃ¢ce Ã  l'extension de `JpaRepository`, vous avez accÃ¨s Ã  des mÃ©thodes prÃ©dÃ©finies qui simplifient la gestion des donnÃ©es.

**RÃ©sumÃ© des opÃ©rations CRUD :**

| OpÃ©ration | HTTP Verbe | Endpoint                | Description                               |
|-----------|------------|-------------------------|-------------------------------------------|
| Create    | POST       | `/cards/add`            | CrÃ©e une nouvelle carte.                  |
| Read All  | GET        | `/cards/all`            | RÃ©cupÃ¨re toutes les cartes.               |
| Read One  | GET        | `/cards/{id}`           | RÃ©cupÃ¨re une carte spÃ©cifique par ID.     |
| Update    | PUT        | `/cards/{id}`           | Met Ã  jour une carte spÃ©cifique.          |
| Delete    | DELETE     | `/cards/{id}`           | Supprime une carte spÃ©cifique par ID.     |

---

<a id="postman"></a>
### Annexe 1 : Utilisation de Postman

**Ajouter une Carte :**
- **Ã‰tape 1** : Ouvrez Postman.
- **Ã‰tape 2** : SÃ©lectionnez `POST` et entrez l'URL `http://localhost:8080/cards/add`.
- **Ã‰tape 3** : SÃ©lectionnez `raw` et `JSON` dans l'onglet Body, puis collez le JSON de la carte.
- **Ã‰tape 4** : Cliquez sur `Send`.

**RÃ©cupÃ©rer toutes les Cartes :**
- **Ã‰tape 1** : SÃ©lectionnez `GET` et entrez l'URL `http://localhost:8080/cards/all`.
- **Ã‰tape 2** : Cliquez sur `Send`.

---

<a id="methods"></a>
### Annexe 2 : MÃ©thodes du `CardRepository`

| MÃ©thode            | Description                                             |
|--------------------|---------------------------------------------------------|
| `save(Card card)`  | Enregistre ou met Ã  jour une carte dans la base de donnÃ©es. |
| `findAll()`        | RÃ©cupÃ¨re toutes les cartes de la base de donnÃ©es.       |
| `findById(int id)` | RÃ©cupÃ¨re une carte par son ID.                          |
| `delete(Card card)`| Supprime une carte de la base de donnÃ©es.               |

---
