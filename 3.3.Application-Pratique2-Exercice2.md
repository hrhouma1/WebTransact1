# üìò Application Pratique : Exercice 2 - Int√©gration de JPA avec PostgreSQL

## Objectif
- Cet exercice a pour but de vous guider dans l'int√©gration de JPA (Jakarta Persistence API) avec une base de donn√©es PostgreSQL dans votre projet Spring Boot. -
- Vous allez apprendre √† configurer une base de donn√©es, cr√©er des entit√©s, et utiliser JPA pour interagir avec la base de donn√©es.
- Vous allez int√©grer JPA avec PostgreSQL dans votre projet Spring Boot. 
- Je vous pr√©sente les objectifs de l'exercice:

1. **Ajout des D√©pendances JPA et PostgreSQL** dans `pom.xml`.
2. **Configuration PostgreSQL** dans `application.properties`.
3. **Cr√©ation des Entit√©s `Customer` et `Card` en JPA**.
4. **Cr√©ation d'un Repository** pour l'entit√© `Card`.
5. **Modification du Contr√¥leur `CardController`**.
6. **V√©rification et ajout de donn√©es via l'interface graphique PostgreSQL**.
7. **Ex√©cution des Commandes Maven**.
8. **Test des Nouveaux Endpoints**.
9. **M√©thodes pour ex√©cuter une requ√™te GET** pour r√©cup√©rer les cartes.

- Ce guide couvre les √©tapes de configuration, la cr√©ation d'entit√©s et de repositories, ainsi que la modification des contr√¥leurs pour interagir avec la base de donn√©es.


## √âtapes

# 1. Ajouter les D√©pendances JPA et PostgreSQL
Pour commencer, nous devons ajouter les d√©pendances n√©cessaires pour JPA et PostgreSQL dans le fichier `pom.xml`.

- **Ouvrez le fichier `pom.xml` dans VS Code.**
- **Ajoutez les d√©pendances suivantes :**

```xml
<dependencies>
    <!-- D√©pendance pour JPA avec Jakarta -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>

    <!-- D√©pendance pour PostgreSQL -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
        <version>42.3.1</version>
    </dependency>
</dependencies>
```

# 2. Configurer PostgreSQL

#### 2.1. Configuration du fichier `application.properties` de votre application

Vous devez configurer l'acc√®s √† la base de donn√©es PostgreSQL dans le fichier `application.properties`.

- **Cr√©ez ou ouvrez le fichier `src/main/resources/application.properties`.**
- **Ajoutez les configurations suivantes pour PostgreSQL :**

```properties
spring.datasource.url=jdbc:postgresql://localhost:5432/votre_base_de_donn√©es
spring.datasource.username=votre_nom_utilisateur
spring.datasource.password=votre_mot_de_passe

spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
```

- **Remplacez `votre_base_de_donn√©es`, `votre_nom_utilisateur`, et `votre_mot_de_passe` par les informations de votre configuration PostgreSQL.**

#### Exemple de configuration

```properties
spring.datasource.url=jdbc:postgresql://localhost:5432/haythem
spring.datasource.username=hrgres
spring.datasource.password=hrgres

spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
```

- **Explication :**
  - `spring.datasource.url` : Sp√©cifie l'URL de connexion √† la base de donn√©es PostgreSQL. Dans cet exemple, la base de donn√©es s'appelle `haythem`.
  - `spring.datasource.username` et `spring.datasource.password` : Indiquent le nom d'utilisateur et le mot de passe pour se connecter √† la base de donn√©es PostgreSQL. Ici, nous utilisons `hrgres` pour les deux.
  - `spring.jpa.properties.hibernate.dialect` : D√©finit le dialecte Hibernate √† utiliser pour PostgreSQL, ce qui permet √† JPA de traduire correctement les requ√™tes en SQL.
  - `spring.jpa.hibernate.ddl-auto` : Indique que Hibernate doit g√©rer automatiquement la cr√©ation et la mise √† jour des tables de la base de donn√©es.


#### 2.2. üèóÔ∏è **Cr√©ation de la base de donn√©es `haythem` (par exemple) dans PostgreSQL avec les bons privil√®ges**

**Important :** √Ä ce stade, vous devez cr√©er la base de donn√©es `haythem` dans PostgreSQL. Pour ce faire, suivez les √©tapes ci-dessous :


2.2.1. **Cr√©er un r√¥le utilisateur** : Acc√©dez √† "Login/Group Roles" et cr√©ez un nouveau r√¥le `hrgres` avec les privil√®ges appropri√©s (*voir la figure ci-bas*).

2.2.2. **Configurer les privil√®ges** : Assurez-vous que le r√¥le dispose des privil√®ges n√©cessaires comme la possibilit√© de cr√©er des bases de donn√©es.

![image](https://github.com/user-attachments/assets/c6539777-5fca-4366-ab00-6fe2a38749b5)

2.2.3. **Cr√©er la base de donn√©es** : Cr√©ez une nouvelle base de donn√©es appel√©e `haythem` et attribuez-la √† l'utilisateur `hrgres`.

![image](https://github.com/user-attachments/assets/26e1c3dc-675b-4324-ae5d-ea4cd00a0305)


# 3. Cr√©er les Entit√©s `Customer` et `Card` en JPA

#### 3.1. Cr√©ez la classe `Customer`
Pour commencer, vous allez cr√©er la classe `Customer` dans le dossier `model`.

- **Structure des dossiers :**

```
cards-app
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ       ‚îî‚îÄ‚îÄ java
‚îÇ           ‚îî‚îÄ‚îÄ com
‚îÇ               ‚îî‚îÄ‚îÄ exemple
‚îÇ                   ‚îî‚îÄ‚îÄ demo
‚îÇ                       ‚îî‚îÄ‚îÄ model
                            ‚îú‚îÄ‚îÄ Customer.java
                            ‚îî‚îÄ‚îÄ Card.java
```

- **Cr√©ez la classe `Customer` dans le dossier `model`.**
- **Ajoutez le code suivant √† `Customer.java` :**

```java
package com.exemple.demo.model;

import jakarta.persistence.*;

@Entity
@Table(name = "customer")
public class Customer {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "customer_id")
    private int customerId;

    @Column(name = "customer_last_name")
    private String customerLastName;

    @Column(name = "customer_first_name")
    private String customerFirstName;

    // Constructeurs

    public Customer() {
    }

    public Customer(String customerLastName, String customerFirstName) {
        this.customerLastName = customerLastName;
        this.customerFirstName = customerFirstName;
    }

    // Getters et Setters

    public int getCustomerId() {
        return customerId;
    }

    public void setCustomerId(int customerId) {
        this.customerId = customerId;
    }

    public String getCustomerLastName() {
        return customerLastName;
    }

    public void setCustomerLastName(String customerLastName) {
        this.customerLastName = customerLastName;
    }

    public String getCustomerFirstName() {
        return customerFirstName;
    }

    public void setCustomerFirstName(String customerFirstName) {
        this.customerFirstName = customerFirstName;
    }
}
```

#### 3.2. Transformer `Card` en une entit√© JPA

- **Modifiez la classe `Card` pour qu'elle ressemble √† ceci :**

```java
package com.exemple.demo.model;

import java.time.LocalDate;
import jakarta.persistence.*;

@Entity
@Table(name = "card")
public class Card {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "card_id")
    private int cardId;

    @ManyToOne
    @JoinColumn(name = "customer_id", nullable = false)
    private Customer customer;

    @Column(name = "card_number")
    private String cardNumber;

    @Column(name = "card_type")
    private String cardType;

    @Column(name = "total_limit")
    private int totalLimit;

    @Column(name = "amount_used")
    private int amountUsed;

    @Column(name = "available_amount")
    private int availableAmount;

    @Column(name = "create_dt")
    private LocalDate createDt;

    // Constructeurs

    public Card() {
    }

    public Card(Customer customer, String cardNumber, String cardType, int totalLimit, int amountUsed, int availableAmount, LocalDate createDt) {
        this.customer = customer;
        this.cardNumber = cardNumber;
        this.cardType = cardType;
        this.totalLimit = totalLimit;
        this.amountUsed = amountUsed;
        this.availableAmount = availableAmount;
        this.createDt = createDt;
    }

    // Getters et Setters

    public int getCardId() {
        return cardId;
    }

    public void setCardId(int cardId) {
        this.cardId = cardId;
    }

    public Customer getCustomer() {
        return customer;
    }

    public void setCustomer(Customer customer) {
        this.customer = customer;
    }

    public String getCardNumber() {
        return cardNumber;
    }

    public void setCardNumber(String cardNumber) {
        this.cardNumber = cardNumber;
    }

    public String getCardType() {
        return cardType;
    }

    public void setCardType(String cardType) {
        this.cardType = cardType;
    }

    public int getTotalLimit() {
        return totalLimit;
    }

    public void setTotalLimit(int totalLimit) {
        this.totalLimit = totalLimit;
    }

    public int getAmountUsed() {
        return amountUsed;
    }

    public void setAmountUsed(int amountUsed) {
        this.amountUsed = amountUsed;
    }

    public int getAvailableAmount() {
        return availableAmount;
    }

    public void setAvailableAmount(int availableAmount) {
        this.availableAmount = availableAmount;
    }

    public LocalDate getCreateDt() {
        return createDt;
    }

    public void setCreateDt(LocalDate createDt) {
        this.createDt = createDt;
    }
}
```

# 4. Cr√©er un Repository pour l'Entit√© `Card`

Un repository est une interface qui vous permet de manipuler les donn√©es de votre entit√©.

- **Cr√©ez une nouvelle interface `CardRepository` dans le dossier `repository` (√† cr√©er dans `com/exemple/demo`).**

- **Structure de Dossier :**
  - Vous devez vous assurer que la structure de votre projet est correcte avant de continuer.
  - Voici √† quoi devrait ressembler l'arborescence des dossiers :

```plaintext
cards-app
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ       ‚îî‚îÄ‚îÄ java
‚îÇ           ‚îî‚îÄ‚îÄ com
‚îÇ               ‚îî‚îÄ‚îÄ exemple
‚îÇ                   ‚îî‚îÄ‚îÄ demo
‚îÇ                       ‚îú‚îÄ‚îÄ model
‚îÇ                       ‚îÇ   ‚îú‚îÄ‚îÄ Customer.java
‚îÇ                       ‚îÇ   ‚îî‚îÄ‚îÄ Card.java
‚îÇ                       ‚îî‚îÄ‚îÄ repository
‚îÇ                           ‚îî‚îÄ‚îÄ CardRepository.java
```


- **Ajoutez le code suivant :**

```java
package com.exemple.demo.repository;

import com.exemple.demo.model.Card;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CardRepository extends JpaRepository<Card, Integer> {
    // Laisser vide pour le moment
}
```

# 5. Modifier le Contr√¥leur `CardController`

Maintenant que vous avez un mod√®le JPA et un repository, vous pouvez modifier le contr√¥leur pour interagir avec la base de donn√©es.

- **Modifiez `CardController.java` pour injecter le repository et g√©rer les requ√™tes :**

```java
package com.exemple.demo.controller;

import com.exemple.demo.model.Card;
import com.exemple.demo.repository.CardRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/cards")
public class CardController {

    @Autowired
    private CardRepository cardRepository;

    @GetMapping("/all")
    public List<Card> getAllCards() {
        return cardRepository.findAll();
    }

    @PostMapping("/add")
    public Card addCard(@RequestBody Card card) {
        return cardRepository.save(card);
    }
}
```


# 6. V√©rifiez votre diagramme de classe et ajoutez un client

- Nous allons v√©rifier l'ajout de deux tables dans la bases de donn√©es via l'interface graphique
- Nous devrons ajouter un client √©tant donn√© la d√©pendance des cartes √† la classe client.

#### 6.1. V√©rification des tables cr√©√©es dans PostgreSQL via l'interface graphique

1. **Ouvrez l'interface graphique de PostgreSQL** : Utilisez un outil comme pgAdmin ou tout autre client graphique pour PostgreSQL.

2. **Acc√©dez √† la base de donn√©es** : S√©lectionnez la base de donn√©es `haythem` que vous avez cr√©√©e.

3. **Naviguez dans les sch√©mas** :
   - Dans le volet de gauche, cliquez sur l'onglet **`Schemas`**.
   - Sous **`Schemas`**, d√©veloppez **`public`**, puis **`Tables`**.

4. **V√©rifiez l'existence des tables** :
   - Assurez-vous que les tables **`customer`** et **`card`** sont pr√©sentes.
   - Cliquez sur chacune de ces tables pour voir leur structure. V√©rifiez que les colonnes sont bien configur√©es avec les types de donn√©es appropri√©s, y compris les cl√©s primaires et √©trang√®res.

#### 6.2. Ins√©rer le client num√©ro 1 : Rehouma Haythem

1. **Acc√©dez √† la table `customer`** :
   - Dans l'interface graphique, faites un clic droit sur la table **`customer`**.
   - S√©lectionnez **`Query Tool`** ou **`Query`** pour ouvrir un nouvel onglet de requ√™te SQL.

2. **Ins√©rez un nouveau client** :
   - Dans la zone de requ√™te SQL, entrez la commande suivante pour ins√©rer un client :

   ```sql
   INSERT INTO public.customer (customer_last_name, customer_first_name)
   VALUES ('Rehouma', 'Haythem');
   ```

   - Ex√©cutez la commande en cliquant sur **`Execute`** (ic√¥ne en forme de triangle ou F5).

   Cela va ins√©rer un client avec le nom `Rehouma` et le pr√©nom `Haythem` dans la table `customer`. Le champ `customer_id` sera automatiquement g√©n√©r√© gr√¢ce √† l'auto-incr√©mentation.

### Structure du projet

- **Structure de Dossier :**
  - Vous devez vous assurer que la structure de votre projet est correcte avant de continuer. Voici √† quoi devrait ressembler l'arborescence des dossiers :

```plaintext
cards-app
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ       ‚îî‚îÄ‚îÄ java
‚îÇ           ‚îî‚îÄ‚îÄ com
‚îÇ               ‚îî‚îÄ‚îÄ exemple
‚îÇ                   ‚îî‚îÄ‚îÄ demo
‚îÇ                       ‚îú‚îÄ‚îÄ model
‚îÇ                       ‚îÇ   ‚îú‚îÄ‚îÄ Customer.java
‚îÇ                       ‚îÇ   ‚îî‚îÄ‚îÄ Card.java
‚îÇ                       ‚îî‚îÄ‚îÄ repository
‚îÇ                           ‚îî‚îÄ‚îÄ CardRepository.java
```

- **Diagramme :**

```plaintext
+--------------------------+             +--------------------------+
|        Customer           |             |          Card            |
+--------------------------+             +--------------------------+
| - customerId              | <-----------| - customerId             |
| - customerLastName        |             | - cardId                 |
| - customerFirstName       |             | - cardNumber             |
+--------------------------+             | - cardType               |
                                          | - totalLimit             |
                                          | - amountUsed             |
                                          | - availableAmount        |
                                          | - createDt               |
                                          +--------------------------+
```


### 7. Ex√©cutez les Commandes Maven dans VS Code

- **Nettoyer le projet :**  
  ```bash
  mvn clean
  ```

- **Compiler et installer le projet :**  
  ```bash
  mvn install -DskipTests
  ```

- **D√©marrer l'application Spring Boot :**  
  ```bash
  mvn spring-boot:run
  ```

### 8. Testez les Nouveaux Endpoints

- **Ajouter une nouvelle carte :**
  - Utilisez un outil comme Postman pour envoyer une requ√™te POST √† `http://localhost:8080/cards/add` avec un corps JSON comme :
    ```json
    {
        "customerId": 1, 
        "cardNumber": "1234-5678-9012-3456",
        "cardType": "Visa",
        "totalLimit": 5000,
        "amountUsed": 1000,
        "availableAmount": 4000,
        "createDt": "2024-08-30"
    }
    ```


- **Important :** Assurez-vous d'avoir un client existant avec l'ID `1` dans la base de donn√©es. Il est essentiel d'avoir ins√©r√© un client au pr√©alable, sinon cette op√©ration √©chouera.






# üìã R√©cup√©rer toutes les cartes

Envoyez une requ√™te GET √† `http://localhost:8080/cards/all` pour voir toutes les cartes dans la base de donn√©es.

# üö® *R√©sultat Attendu*

Le projet Spring Boot doit √™tre capable d'interagir avec la base de donn√©es PostgreSQL, permettant d'ajouter et de r√©cup√©rer des cartes en utilisant les endpoints que vous avez cr√©√©s.

# üö® *200 ou 500 ?*
---

# üòÖ **Oups ! √áa ne marche pas ? C'est un 500 ?**

Eh bien, il semble que quelque chose cloche... Mais ne paniquez pas üõë ! C'√©tait pour tester votre vigilance üßê ! 

üö® **Pas de panique !** üö® Respirez un grand coup, et prenez le temps de r√©soudre ce probl√®me.

# üéØ Voici votre mission :
- **Prenez au maximum 2 heures** pour essayer de r√©soudre ce souci. C‚Äôest une super occasion d'apprendre !
- **√âtapes √† suivre :**
  1. **V√©rifiez le code** : Il pourrait y avoir une petite erreur quelque part. Soyez m√©thodiques !
  2. **Demandez de l'aide √† un coll√®gue ou √† votre prof** si vous √™tes coinc√©.

Si vous √™tes toujours perdu apr√®s 2 heures (pas avant !), rendez-vous √† la section [**3.3 Troubleshooting-add**](3.3.Troubleshooting-add.md) pour la solution. üòä

Bonne chance, et rappelez-vous : le plus important est de comprendre ce qui se passe sous le capot üõ†Ô∏è !


------------

# üéâüéâ **F√©licitations** üéâüéâ

Vous avez obtenu **28%** du lab üíØ ! C‚Äôest **garanti** si vous √™tes arriv√©(e) jusque-l√† ! üòé Maintenant, on va chercher ensemble les **78% restants**. üìà

‚û°Ô∏è **Pas question de tester votre vigilance maintenant, mais sachez que vous √™tes le/la Boss !** üëë Vous √™tes les ma√Ætres de Spring Boot ‚öôÔ∏è, et je suis **super fier** de vous ! üí™üéâ

‚û°Ô∏è‚û°Ô∏è **Continuez et progressez !** üîù Vous √™tes √† un pas de devenir des **experts** dans ce domaine ! üåü

‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è **Rendez-vous ici pour la suite !** üìÖ üèÅ

‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è‚û°Ô∏è   [**3.3 Troubleshooting-add**](4.3.Cahier-de-charge-partie-1.md) 

------
------
------
------

# Annexe 01 - comment  ex√©cuter la requ√™te GET pour r√©cup√©rer toutes les cartes ?


- Je vous propose plusieurs m√©thodes pour ex√©cuter la requ√™te GET et r√©cup√©rer toutes les cartes dans la base de donn√©es. Choisissez celle qui vous convient le mieux selon vos pr√©f√©rences ou outils disponibles !
- vous pouvez ex√©cuter la requ√™te GET pour r√©cup√©rer toutes les cartes dans la base de donn√©es en utilisant diff√©rentes m√©thodes :

### M√©thode 1 : Utiliser le Navigateur

- **URL √† entrer** : Ouvrez votre navigateur web et entrez l'URL suivante :
  ```
  http://localhost:8080/cards/all
  ```
- **R√©sultat** : Vous verrez la r√©ponse au format JSON s'afficher directement dans le navigateur, √† condition que l'application soit en cours d'ex√©cution et que le serveur soit accessible.

### M√©thode 2 : Utiliser Postman

- **Ouvrez Postman** : Lancez l'application Postman.
- **Cr√©er une nouvelle requ√™te** :
  - S√©lectionnez **GET** comme type de requ√™te.
  - Entrez l'URL : `http://localhost:8080/cards/all`
- **Envoyez la requ√™te** : Cliquez sur **Send** pour envoyer la requ√™te.
- **R√©sultat** : La r√©ponse s'affichera dans la fen√™tre de r√©ponse en bas, au format JSON.

### M√©thode 3 : Utiliser Fetch API dans le Navigateur

- **Ouvrez la console du navigateur** : Dans Chrome, faites `Ctrl+Shift+J` (Windows/Linux) ou `Cmd+Option+J` (Mac) pour ouvrir la console JavaScript.
- **Ex√©cutez le code suivant** :
  ```javascript
  fetch('http://localhost:8080/cards/all')
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));
  ```
- **R√©sultat** : Les donn√©es seront affich√©es dans la console du navigateur.

### M√©thode 4 : Utiliser `curl` dans le Terminal

- **Ouvrez un terminal** :
  - Sous Windows, vous pouvez utiliser `cmd` ou PowerShell.
  - Sous Linux ou Mac, ouvrez votre terminal habituel.
- **Ex√©cutez la commande `curl` suivante** :
  ```bash
  curl -X GET http://localhost:8080/cards/all
  ```
- **R√©sultat** : La r√©ponse JSON s'affichera directement dans le terminal.

### M√©thode 5 : Utiliser l'Extension REST Client dans VS Code

1. **Installez l'extension REST Client** :
   - Ouvrez VS Code, allez dans le Marketplace (ic√¥ne en forme de carr√© sur la gauche), et cherchez "REST Client".
   - Installez l'extension.

2. **Cr√©er un fichier `.http`** :
   - Dans votre projet, cr√©ez un nouveau fichier avec l'extension `.http` (par exemple, `get-cards.http`).
   
3. **Ajoutez la requ√™te suivante** :
   ```http
   GET http://localhost:8080/cards/all
   ```

4. **Ex√©cutez la requ√™te** :
   - Placez votre curseur sur la ligne `GET http://localhost:8080/cards/all`.
   - Cliquez sur le bouton **Send Request** qui appara√Ætra au-dessus de la ligne.
   
- **R√©sultat** : La r√©ponse s'affichera dans un nouvel onglet dans VS Code.


